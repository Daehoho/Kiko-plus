---
layout: post
title: "엘라스틱서치(2) - 설치와 실행"
description: "엘라스틱서치 설치와 실행"
date: 2017-09-03
tags: [엘라스틱 서치]
comments: false
share: true
---

이 글을 엘라스틱 서치를 학습하면서 정리를 위해 적는 글입니다. 또한 이 글은 '시작하세요! 엘라스틱 서치'를 참고하여 작성하였습니다.

--- 
> 책에서는 elasticsearch 1.1.1버전으로 진행하였으나 저는 5.5.2 버전을 이용하여 진행하였습니다.
> 또한 MAC OSX(Sierra 10.12.3)환경에서 실습을 진행하였습니다.

## 2. 엘라스틱서치 설치

##### 2.1 엘라스틱서치 다운로드
엘라스틱서치 공식 홈페이지(https://www.elastic.co/downloads/elasticsearch#ga-release)에서 다음과 같은 화면에서 내려받아 설치할 수 있다.

![엘라스틱서치 다운로드](https://daehoho.github.io/images/elastic_install/elastic_install_1.png){: .center-image}

```css
 tar -xvf elasticsearch-5.5.2.tar.gz 
```

저는 TAR파일을 다운받아 위와 같은 명령어로 압축을 풀어 주었습니다.
![엘라스틱서치 디렉토리 구조](https://daehoho.github.io/images/elastic_install/elastic_install_2.png){: .center-image}
압축을 풀고난 디렉토리 구조는 위의 이미지와 같습니다.

##### 2.2 엘라스틱서치 설치와 실행
 다운로드 페이지에서 DEB과 RPM 파일은 엘라스틱서치를 서비스로 설치하기 위한 파일입니다. 맥 OS에서는 서비스 설치 파일을 지원하지 않기때문에 TAR 파일을 내려받아 프로그램을 직접 실행해야 합니다.
 엘라스틱서치를 직접 실행하기 위해서 압축을 푼 디렉토리에서 bin 디렉토리로 이동해보았습니다.
 
![bin 디렉토리](https://daehoho.github.io/images/elastic_install/elastic_install_3.png){: .center-image}

 bin 디렉토리 내부에는 *.bat 형태의 여러 배치 파일과 *.exe 형태의 윈도우 운영체제의 실행 파일이 있습니다. 유닉스 환경에서는 elasticsearch 파일을 실행합니다.
 
![엘라스틱서치 실행-1](https://daehoho.github.io/images/elastic_install/elastic_install_4.png){: .center-image}
![엘라스틱서치 실행-2](https://daehoho.github.io/images/elastic_install/elastic_install_5.png){: .center-image}


bin/elasticsearh를 실행하면 위와 같이 엘라스틱 서치가 실행됩니다. 또한 실행할때 뒤에 추가로 옵션을 사용할 수 있다.


> * -d : 엘라스틱서치를 백그라운드로 실행
> * -p <filename> : 엘라스틱서치의 프로세스 id를 <filename>으로 지정된 파일에 저장


![엘라스틱서치 백그라운드 실행]
(https://daehoho.github.io/images/elastic_install/elastic_install_6.png){: .center-image}

-d 옵션을 추가해서 엘라스틱서치를 백그라운드로 실행하면 위와 같이 화면에 아무런 출력도 없이 실행이 된다.
실행 중인 엘라스틱서치의 로그는 logs/elasticsearch.log파일에 기록된다.
```css
tail -f log/elatsticsearch.log 
```
위와 같이 명령어를 입력하면 출력되는 로그를 실시간으로 확인할 수 있다.

> * tail 명령어 : tail은 문서의 마지막 라인부터 시작하여 지정한 라인까지 보여준다.
> * 사용법 : tail [option] file
> * -n [단위] : 파일의 마지막부터 n 번째까지 보여준다.
> * -f : 파일의 마지막 10라인을 실시간으로 계속해서 출력


![실행중인 노드명](https://daehoho.github.io/images/elastic_install/elastic_install_7.png){: .center-image}
로그 파일을 살펴보면 위와 같이 [HRpitM6]가 있는데 이는 실행된 엘라스틱서치의 노드명이다. 노드이름은 별도로 설정하지 않으면 엘라스틱서치를 실행할 때마다 임의로 생성된다.
유닉스의 curl 명령어를 사용해 엘라스틱서치가 제공하는 REST API를 사용하여 현재 실행중인 엘라스틱서치의 프로세스 정보를 가져올 수 있다.
![REST API](https://daehoho.github.io/images/elastic_install/elastic_install_8.png){: .center-image}






##### 아파치 루씬 기반
 아파치 루씬은 자바 언어로 개발된 검색 라이브러리 입니다. 아파치 루씬은 매우 강력한 기능이 있는 검색엔진으로 사용자 위치 정보(geolocation)를 이용할 수 있고, 다국어 검색, 철자 수정 기능, 자동완성, 미리보기 등의 다양한 기능을 지원합니다.엘라스틱서치는 아파치 루씬을 기반으로 만들어졌기 때문에 루씬의 기능을 대부분 지원합니다.
 
##### 실시간 분석
 엘라스틱서치에 저장된 데이터는 검색에 사용되기 위해 별도의 재시작이나 상태의 갱신이 필요하지 않습니다. 데이터는 색인 작업이 완료됨과 동시에 바로 검색할 수 있으며 이러한 특징을 실시간(Real Time)분석이라 부릅니다.
 
##### 분산 시스템
 엘라스틱서치는 여러 개의 노드로 구성되는 분산 시스템(Distributed)입니다. 노드는 데이터를 색인하고 검색 기능을 수행하는 엘라스틱서치의 단위 프로세스입니다. 소규모의 시스템에서 적은 수의 노드로 시스템을 구성한 후에 시스템의 규모가 늘어나면 기존 노드에 새 노드를 실행해 연결하는 것으로 쉽게 시스템을 확장 할 수 있습니다.
 
##### 높은 가용성
 엘라스틱 서치는 하나 이상의 노드로 구성돼 있으며, 각 노드는 1개 이상의 데이터 원본과 복사본을 가지고 있어 서로 다른 위치에 나누어 저장합니다. 노드가 종료되거나 실행해 실패(Fail)하는 경우 엘라스틱서치는 노드들의 상태를 감지하고 종료된 노드가 가지고 있던 데이터를 다른 노드로 옮기는 작업을 수행합니다. 이러한 과정으로 엘라스티 서치는 높은 가용성(High Availability)과 안정성을 보장합니다.
 > 가용성 : 서버와 네트워크, 프로그램 등의 정보 시스템이 정상적으로 사용 가능한 정도를 말한다. 가동률과 비슷한 의미이다. 전체 사용 시간 대비 정상적인 사용 시간이 높을수록 "가용성이 높다"고 표현한다.


##### 멀티 테넌시
 엘라스틱서치의 데이터는 여러 개로 분리된 인덱스들(Indices)에 그룹으로 저장됩니다. 인덱스는 관계형 DB 모델에서 데이터베이스로 대응되는데, 관계형 DB에서 다른 데이터베이스의 데이터를 검색하려면 별도의 커넥션을 생성해야 하는 것과 달리 엘라스틱서치에서는 데이터를 검색할 때 서로 다른 인덱스의 데이터를 바로 하나의 질의뢰 묶어서 검색하고 여러 검색 결과를 하나의 출력으로 도출할 수 있습니다.
 
##### 전문검색
 엘라스틱서치는 데이터 색인(Indexing)을 이용한 전문검색(Full Text Search)을 지원합니다. 데이터의 전체 문장에서 검색어를 추출해 저장하고 이를 바탕으로 검색하는 전문검색을 지원합니다.
 
##### JSON 문서 기반
 엘라스틱서치의 모든 데이터는 기본적으로 문서의 모든 필드가 색인돼 JSON 구조로 저장됩니다. 그러므로 모든 레벨의 필드에 접근이 쉽고, 매우 빠른 속도로 검색됩니다. 또한, NoSQL과 같이 스키마 프리(Schema Free)를 지원하므로 별도의 사전 매핑 없이도 JSON 문서 형식으로 데이터를 입력하면 바로 검색 가능한 형태로 색인 작업이 수행됩니다.
 
##### RESTFul API
 Restful API를 지원하므로 URI를 사용한 동작이 가능합니다. 또한, HTTP 프로토콜로 JSON 문서의 입출력과 다양한 제어를 할 수 있습니다. 
 

## 2. 데이터 색인
 아파치 루씬과 엘라스틱서치에서 사용되는 몇 가지 중요한 개념의 용어를 정리해보았습니다. 
 > * [동사] 색인(indexing) : 검색할 데이터를 검색할 수 있는 구조로 변경하기 위해 원본 문서를 변환하여 저장하는 일련의 과정
 > * [명사] 색인(index) : 색인 과정을 거친 결과물 또는 색인된 데이터가 저장되는 데이터 공간. 제가 보고 있는 책에서는 색인 또는 색인 공간이라 명명합니다.
 > * 검색(searching) : 색인에 들어있는 토큰을 기준으로 해당하는 토큰이 포함되는 문서를 찾는 과정.
 > * 질의(query) : 사용자가 원하는 결과를 출력하기 위해 검색 시 입력하는 검색어 또는 검색 조건.

##### 관계형 DB와 엘라스틱서치 데이터 저장 방식 비교

||구조|설명|
|:---:|:---:|:---|
|관계형DB|테이블구조|테이블의 행은 데이터베이스의 객체를 표현하고, 테이블의 열은 테이블에 있는 객체들의 속성이나 특성 값을 표현합니다.|
|엘라스틱서치|역파일색인|데이터를 검색할수 있는 구조로 저장하기 위해 색인(indexing) 절차를 거쳐 입력된 텍스트를 토큰으로 변환해 역파일 색인(inverted index)라는 구조로 저장합니다..|

###### 1. 관계형 DB 테이블에서 텍스트 저장
 관계형 DB에서는 데이터들 다음과 같이 전체 텍스트를 하나의 칼럼으로 저장합니다.
 
|문서|문서내용|
|:---:|:---|
|Doc1|blue sky green land red sun|
|Doc2|blue ocean green land|
|Doc2|red flower blue sky|

###### 2. 색인 공간에 저장된 역파일 색인 데이터 구조
엘라스틱 서치에서는 이러한 원본 문서에 대한 색인 과정을 진행해 해당 문서들의 텍스트를 추출한 뒤 색인 공간에 저장합니다. 역으로 각 테스트의 토큰들이 해당 텍스트를 포함하는 문서를 가리키는 구조로 저장됩니다. 

|검색어|검색어가 가리키는 문서|
|:---:|:---|
|blue|Doc1, Doc2, Doc3|
|sky|Doc1, Doc3|
|green|Doc1, Doc2|
|land|Doc1, Doc2|
|red|Doc1, Doc3|
|ocean|Doc2|
|flower|Doc3|
|sun|Doc1|

검색 과정은 위와 같이 색인된 텍스트를 검색해 해당 텍스트가 포함된 문서를 결과로 출력하는 과정으로 이루어집니다. 관계형 DB에서는 sky라는 단어를 검색하면 Doc1, Doc2, Doc3 문서를 차례로 읽어내려 가며 찾아가지만, 엘라스틱서치에서는 문서를 미리 색인해서 색인 공간에 위의 표와 같은 역파일 색인 데이터 구조를 만들어 놓고, sky를 검색했을 때 색인 공간에서 sky 단어가 가리키는 Doc1, Doc3 문서를 출력합니다.

## 3. JSON 문서와 REST API

##### JSON 문서
JSON(JavaScript Object Notation)은 웹에서 자료를 주고받을 때 사용하는 경량 데이터 형식입니다. JSON은 다음과 같은 규칙이 있습니다.
> * 수는 기본적으로 정수와 실수로 표현하며, 기호로 묶지 않는다.
> * 문자열은 항상 큰따옴표(")로 묶어야 한다. 문자열 안에서의 역슬래시(\)는 제어 문자로 사용된다.
> * 참/거짓은 true/false로 표현하며, 기호로 묶지 않는다.
> * 객체는 name: value의 쌍으로 된 비 순서화된 SET이다. 객체는 중괄호({})로 묶인다. 각 name의 뒤에는 콜론(:)을 붙이고 쉼표(,) name:value 쌍을 구분 짓는다. name은 문자열이므로 따옴표(")로 묶어 사용한다. value에는 기본 자료형과 객체, 배열 자료형의 요소, 그리고 null이 올 수 있다.
> * 배열은 순서화된 SET이며 대괄호([])로 묶인다. 각 배열 요소에는 기본 자료형과 객체, 배열의 집합 자료형이 올 수 있다.

다음은 JSON 문서의 예제이다.
```css
 {
   "이름" : "홍길동",
   "나이" : 26,
   "성별" : "남",
   "특기" : ["축구", "팟캐스트청취"],
   "가족" : {
      "아버지" : {"이름" : "홍길남", "나이" : 56},
      "어머니" : {"이름" : "김길순", "나이" : 53},
      "형제": [{"이름" : "귀동", "나이" : 28}, {"이름" : "일동", "나이" : 25}]
    }
 }
```

##### REST API
REST는 자원지향구조(ROA: Resource Oriented Architecture)로 웹의 콘텐츠(텍스트, 이미지, 동영상)를 하나의 자원으로 파악하여 각 자원의 고유한 URI를 부여하고 해당 자원에 대한 CRUD 작업을 HTTP의 기본 메서드인 POST, GET, PUT, DELETE를 이용해 처리하는 방식입니다.

###### HTTP 메서드, CRUD, SQL 비교

|HTTP메서드|CRUD|SQL|
|:---|:---|:---|
|GET|Read|Select|
|PUT|Update|Update|
|POST|Create|Insert|
|DELETE|Delete|Delete|

엘라스틱서치에서의 REST 자원은 색인된 데이터 및 질의, 검색되어 JSON 형식으로 출력된 문서들입니다. 엘라스틱 JSON 문서를 URI로 명시하고 이 문서를 처리하기 위해 POST, GET, PUT, DELETE 메서드를 이용한다고 볼 수 있습니다.

